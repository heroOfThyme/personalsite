---
import { APP_BLOG } from 'astrowind:config';
import { Icon } from 'astro-icon/components';
import { getBlogPermalink } from '~/utils/permalinks';
import { findLatestPosts } from '~/utils/blog';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import type { Widget } from '~/types';

export interface Props extends Widget {
  title?: string;
  subtitle?: string;
  tagline?: string;
  linkText?: string;
  linkUrl?: string | URL;
  information?: string;
  count?: number;
  postLayout?: 'grid' | 'list';
}

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  linkText = 'View all posts',
  linkUrl = getBlogPermalink(),
  information = await Astro.slots.render('information'),
  count = 3,
  postLayout = 'grid',
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

const posts = APP_BLOG.isEnabled ? await findLatestPosts({ count }) : [];
---

{
  APP_BLOG.isEnabled ? (
    <WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-7xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
      <div class="mb-12 text-center">
        {tagline && (
          <p class="inline-block px-3 py-1 text-xs font-medium tracking-wider text-indigo-700 uppercase bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 rounded-full mb-4">
            {tagline}
          </p>
        )}
        
        {title && (
          <h2 class="text-3xl md:text-4xl font-bold tracking-tight mb-4">
            {title}
          </h2>
        )}
        
        {subtitle && <p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">{subtitle}</p>}

        {information && <p class="text-muted dark:text-slate-400 max-w-2xl mx-auto mt-2">{information}</p>}
      </div>

      {postLayout === 'grid' ? (
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post) => (
            <article class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="relative">
                {post.image && (
                  <a href={post.permalink}>
                    <Image
                      src={post.image}
                      class="w-full h-48 object-cover"
                      width={400}
                      height={200}
                      alt={post.title}
                      aspectRatio="2:1"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                  </a>
                )}
                
                {post.category && (
                  <a 
                    href={`/category/${post.category.slug}`} 
                    class="absolute top-3 right-3 bg-indigo-600 text-white text-xs font-medium px-3 py-1 rounded-full hover:bg-indigo-700 transition-colors"
                  >
                    {post.category.title}
                  </a>
                )}
              </div>
              
              <div class="p-6">
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-3">
                  <Icon name="tabler:calendar" class="w-4 h-4" />
                  <time datetime={post.publishDate.toISOString()}>
                    {new Date(post.publishDate).toLocaleDateString('en-us', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>
                  
                  {post.readingTime && (
                    <span class="flex items-center gap-1 ms-3">
                      <Icon name="tabler:clock" class="w-4 h-4" />
                      {post.readingTime} min read
                    </span>
                  )}
                </div>
                
                <h3 class="text-xl font-bold mb-2">
                  <a href={post.permalink} class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                    {post.title}
                  </a>
                </h3>
                
                <p class="text-gray-600 dark:text-gray-300 line-clamp-2 mb-4">
                  {post.excerpt}
                </p>
                
                <div class="flex justify-between items-center">
                  <div class="flex flex-wrap gap-2">
                    {post.tags && post.tags.slice(0, 2).map((tag) => (
                      <a 
                        href={`/tag/${tag.slug}`} 
                        class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                      >
                        {tag.title}
                      </a>
                    ))}
                  </div>
                  
                  <a 
                    href={post.permalink} 
                    class="flex items-center gap-1 text-indigo-600 dark:text-indigo-400 font-medium text-sm hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors"
                  >
                    Read more
                    <Icon name="tabler:arrow-right" class="w-4 h-4" />
                  </a>
                </div>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="space-y-8">
          {posts.map((post) => (
            <article class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700 transition-all duration-300 hover:shadow-lg">
              <div class="md:flex">
                {post.image && (
                  <div class="md:w-1/3">
                    <a href={post.permalink} class="block h-full">
                      <Image
                        src={post.image}
                        class="w-full h-48 md:h-full object-cover"
                        width={400}
                        height={300}
                        alt={post.title}
                        aspectRatio="4:3"
                      />
                    </a>
                  </div>
                )}
                
                <div class="p-6 md:w-2/3">
                  {post.category && (
                    <a 
                      href={`/category/${post.category.slug}`} 
                      class="inline-block bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300 text-xs font-medium px-3 py-1 rounded-full mb-3 hover:bg-indigo-200 dark:hover:bg-indigo-800/30 transition-colors"
                    >
                      {post.category.title}
                    </a>
                  )}
                  
                  <h3 class="text-xl font-bold mb-2">
                    <a href={post.permalink} class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                      {post.title}
                    </a>
                  </h3>
                  
                  <p class="text-gray-600 dark:text-gray-300 mb-4">
                    {post.excerpt}
                  </p>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                      <Icon name="tabler:calendar" class="w-4 h-4" />
                      <time datetime={post.publishDate.toISOString()}>
                        {new Date(post.publishDate).toLocaleDateString('en-us', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                        })}
                      </time>
                      
                      {post.readingTime && (
                        <span class="flex items-center gap-1 ms-3">
                          <Icon name="tabler:clock" class="w-4 h-4" />
                          {post.readingTime} min read
                        </span>
                      )}
                    </div>
                    
                    <a 
                      href={post.permalink} 
                      class="flex items-center gap-1 text-indigo-600 dark:text-indigo-400 font-medium text-sm hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors"
                    >
                      Read more
                      <Icon name="tabler:arrow-right" class="w-4 h-4" />
                    </a>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
      
      {linkText && linkUrl && (
        <div class="mt-12 text-center">
          <Button 
            variant="primary" 
            href={linkUrl} 
            class="group font-medium"
          >
            {linkText}
            <Icon name="tabler:arrow-right" class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" />
          </Button>
        </div>
      )}
    </WidgetWrapper>
  ) : (
    <Fragment />
  )
}