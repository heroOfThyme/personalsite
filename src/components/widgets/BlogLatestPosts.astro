---
import { APP_BLOG } from 'astrowind:config';
import { Icon } from 'astro-icon/components';
import { getBlogPermalink } from '~/utils/permalinks';
import { findLatestPosts } from '~/utils/blog';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import type { Widget } from '~/types';

export interface Props extends Widget {
  title?: string;
  subtitle?: string;
  tagline?: string;
  linkText?: string;
  linkUrl?: string | URL;
  information?: string;
  count?: number;
  postLayout?: 'grid' | 'list';
}

const {
  title = await Astro.slots.render('title') || 'Latest Posts',
  subtitle = await Astro.slots.render('subtitle') || 'Exploring software development, architecture patterns, performance optimization, and the latest in web & mobile technologies. Technical deep-dives and learnings from real-world projects.',
  tagline = await Astro.slots.render('tagline'),
  linkText = 'View all posts',
  linkUrl = getBlogPermalink(),
  information = await Astro.slots.render('information'),
  count = 3,
  postLayout = 'grid',
  id,
  isDark = true,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

const posts = APP_BLOG.isEnabled ? await findLatestPosts({ count }) : [];
---

{
  APP_BLOG.isEnabled ? (
    <WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-7xl ${classes?.container ?? ''}`} bg={bg}>
      <div>
        <!-- Section Header -->
        <div class="section-header">
          <div class="terminal-prompt">
            <span class="prompt">$</span>
            <span class="command">cat blog/*.md</span>
          </div>
          {title && <h2 class="section-title">{title}</h2>}
          {subtitle && <p class="section-subtitle">{subtitle}</p>}
        </div>

      {postLayout === 'grid' ? (
        <div class="blog-grid">
          {posts.map((post) => (
            <article class="blog-card">
              {post.image && (
                <div class="blog-image">
                  <a href={post.permalink}>
                    <Image
                      src={post.image}
                      class="card-image"
                      alt={post.title}
                    />
                  </a>
                  <div class="image-overlay" />
                </div>
              )}

              <div class="blog-content">
                <div class="blog-meta">
                  <div class="meta-item">
                    <Icon name="tabler:calendar" class="meta-icon" />
                    <time datetime={post.publishDate.toISOString()}>
                      {new Date(post.publishDate).toLocaleDateString('en-us', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                      })}
                    </time>
                  </div>
                  {post.readingTime && (
                    <div class="meta-item">
                      <Icon name="tabler:clock" class="meta-icon" />
                      <span>{post.readingTime} min</span>
                    </div>
                  )}
                </div>

                <h3 class="blog-title">
                  <a href={post.permalink}>{post.title}</a>
                </h3>

                {post.excerpt && <p class="blog-excerpt">{post.excerpt}</p>}

                <div class="blog-footer">
                  {post.category && (
                    <span class="blog-category">{post.category.title}</span>
                  )}
                  <a href={post.permalink} class="read-more">
                    Read more
                    <Icon name="tabler:arrow-right" class="arrow-icon" />
                  </a>
                </div>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="space-y-8">
          {posts.map((post) => (
            <article
              class="bg-white dark:bg-gray-950 rounded-xl 
                  shadow-md overflow-hidden border border-gray-100 dark:border-gray-800 
                  transition-all duration-300 hover:shadow-lg relative"
            >
              <div class="md:flex">
                {post.image && (
                  <div class="md:w-1/3">
                    <a href={post.permalink} class="block h-full">
                      <Image
                        src={post.image}
                        class="w-full h-48 md:h-full object-cover"
                        width={400}
                        height={300}
                        alt={post.title}
                        aspectRatio="4:3"
                      />
                    </a>
                  </div>
                )}

                <div class="p-6 md:w-2/3 flex flex-col h-full">
                  <div class="flex-grow">
                    <h3 class="text-xl font-bold mb-2">
                      <a
                        href={post.permalink}
                        class="hover:text-primary dark:hover:text-primary transition-colors"
                      >
                        {post.title}
                      </a>
                    </h3>

                    <p class="text-muted mb-4">{post.excerpt}</p>
                  </div>

                  <div class="flex items-center justify-between mt-auto">
                    <div class="flex items-center gap-2">
                      {post.category && (
                        <a
                          href={`/category/${post.category.slug}`}
                          class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                        >
                          {post.category.title}
                        </a>
                      )}

                      <div class="flex items-center gap-2 text-sm text-primary ml-2">
                        <Icon name="tabler:calendar" class="w-4 h-4" />
                        <time datetime={post.publishDate.toISOString()}>
                          {new Date(post.publishDate).toLocaleDateString('en-us', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                          })}
                        </time>

                        {post.readingTime && (
                          <span class="flex items-center gap-1 ms-3 text-primary">
                            <Icon name="tabler:clock" class="w-4 h-4" />
                            {post.readingTime} min read
                          </span>
                        )}
                      </div>
                    </div>

                    <a
                      href={post.permalink}
                      class="flex items-center gap-1 text-primary dark:text-primary font-medium text-sm transition-colors"
                    >
                      Read more
                      <Icon name="tabler:arrow-right" class="w-4 h-4" />
                    </a>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}

      {linkText && linkUrl && (
        <div class="view-all-container">
          <Button variant="secondary" href={linkUrl} class="view-all-button">
            {linkText}
            <Icon name="tabler:arrow-right" class="button-icon" />
          </Button>
        </div>
      )}
      </div>
    </WidgetWrapper>
  ) : (
    <Fragment />
  )
}

<style>
  /* Section Header */
  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .terminal-prompt {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .prompt {
    color: #3b82f6;
    font-weight: 600;
  }

  .command {
    color: #2563eb;
  }

  .section-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin: 0 0 1rem 0;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .section-subtitle {
    font-size: 1.125rem;
    color: #94a3b8;
    margin: 0 auto;
    max-width: 42rem;
  }

  /* Blog Grid */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    align-items: stretch;
  }

  /* Blog Card */
  .blog-card {
    background: transparent;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 4px;
    overflow: hidden;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100%;
  }

  .blog-card:hover {
    border-color: rgba(59, 130, 246, 0.5);
  }

  .blog-image {
    width: 100%;
    height: 250px;
    position: relative;
    overflow: hidden;
    margin: 0 !important;
    padding: 0 !important;
  }

  .card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .blog-card:hover .card-image {
    transform: scale(1.05);
  }

  .image-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.5) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .blog-card:hover .image-overlay {
    opacity: 1;
  }

  .blog-content {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    gap: 1rem;
  }

  .blog-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #94a3b8;
  }

  .meta-icon {
    width: 0.875rem;
    height: 0.875rem;
    color: #3b82f6;
  }

  .blog-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin: 0;
    line-height: 1.4;
  }

  .blog-title a {
    color: white;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .blog-title a:hover {
    color: #3b82f6;
  }

  .blog-excerpt {
    font-size: 0.875rem;
    color: #94a3b8;
    line-height: 1.6;
    margin: 0;
    padding-left: 1rem;
    border-left: 2px solid rgba(59, 130, 246, 0.5);
  }

  .blog-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    padding-top: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .blog-category {
    padding: 0.25rem 0.625rem;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 4px;
    font-size: 0.75rem;
    color: #60a5fa;
    font-weight: 500;
  }

  .read-more {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #3b82f6;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .read-more:hover {
    color: #60a5fa;
    gap: 0.625rem;
  }

  .arrow-icon {
    width: 0.875rem;
    height: 0.875rem;
    transition: transform 0.2s ease;
  }

  .read-more:hover .arrow-icon {
    transform: translateX(2px);
  }

  /* View All Container */
  .view-all-container {
    margin-top: 3rem;
    text-align: center;
  }

  .view-all-button {
    background: transparent !important;
    border: 1px solid rgba(59, 130, 246, 0.4) !important;
    color: #3b82f6 !important;
    font-size: 0.875rem;
    padding: 0.625rem 1.5rem !important;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .view-all-button:hover {
    background: rgba(59, 130, 246, 0.1) !important;
    border-color: rgba(59, 130, 246, 0.6) !important;
  }

  .button-icon {
    width: 1rem;
    height: 1rem;
    transition: transform 0.2s ease;
  }

  .view-all-button:hover .button-icon {
    transform: translateX(2px);
  }

  /* Mobile Responsive */
  @media (max-width: 1024px) {
    .blog-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .blog-content {
      padding: 1rem;
    }

    .blog-title {
      font-size: 1rem;
    }
  }
</style>